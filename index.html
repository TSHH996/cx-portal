<script>
  const SUPABASE_URL = "https://zwowuhfsorfnhmhvoqsm.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_aqqVrDvfsxUFvN_CbfXwMg_3PpS3xw8";
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (id) => document.getElementById(id);

  const state = {
    lang: "en",
    theme: "dark",
    brandTitle: "CX Portal",
    tickets: [],
    selectedId: null,
    repliesByTicket: {}
  };

  function pad(n){ return String(n).padStart(2, "0"); }

  function fmtDate(d){
    if (!d) return "â€”";
    const dt = new Date(d);
    if (Number.isNaN(dt.getTime())) return "â€”";
    return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())} ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
  }

  function uid(){
    return "TKT-" + Math.floor(100000 + Math.random() * 900000);
  }

  function currentView(){
    if ($("view-tickets").style.display !== "none") return "tickets";
    if ($("view-reports").style.display !== "none") return "reports";
    if ($("view-settings").style.display !== "none") return "settings";
    return "dashboard";
  }

  function setView(view){
    ["dashboard","tickets","reports","settings"].forEach(v=>{
      $("view-" + v).style.display = (v === view) ? "" : "none";
      document.querySelector(`.nav button[data-view="${v}"]`).classList.toggle("active", v === view);
    });

    if (view === "dashboard") {
      $("pageTitle").textContent = "Dashboard";
      $("pageSub").textContent = "Monitor CX performance, ticket flow, and branch replies.";
    }
    if (view === "tickets") {
      $("pageTitle").textContent = "Tickets Inbox";
      $("pageSub").textContent = "Search, filter, assign, and update branch replies in one place.";
      renderTickets();
    }
    if (view === "reports") {
      $("pageTitle").textContent = "Reports";
      $("pageSub").textContent = "Analytics area.";
    }
    if (view === "settings") {
      $("pageTitle").textContent = "Settings";
      $("pageSub").textContent = "Customize portal language, theme, and branding.";
      $("brandInput").value = state.brandTitle;
    }
  }

  function applyTheme(){
    document.body.setAttribute("data-theme", state.theme);
    $("btnThemeTxt").textContent = state.theme === "dark" ? "Dark" : "Light";
  }

  function applyLang(){
    const isAr = state.lang === "ar";
    document.documentElement.lang = isAr ? "ar" : "en";
    document.documentElement.dir = isAr ? "rtl" : "ltr";
    $("btnLang").innerHTML = (isAr ? "ðŸ‡¸ðŸ‡¦" : "ðŸ‡ºðŸ‡¸") + ` <span id="btnLangTxt">${state.lang.toUpperCase()}</span>`;
    $("brandTitle").textContent = state.brandTitle;
  }

  function statusBadgeClass(s){
    if (s === "Replied") return "good";
    if (s === "In Progress") return "warn";
    if (s === "Open") return "warn";
    if (s === "Closed") return "";
    return "";
  }

  function prioBadgeClass(p){
    if (p === "High") return "bad";
    if (p === "Medium") return "warn";
    return "good";
  }

  function getRepliesForTicket(ticketUuid){
    return state.repliesByTicket[ticketUuid] || [];
  }

  function getLatestReply(ticketUuid){
    const replies = getRepliesForTicket(ticketUuid);
    return replies.length ? replies[replies.length - 1] : null;
  }

  function buildTimeline(ticket){
    const timeline = [
      {
        t:"Ticket created",
        d:"Loaded from Supabase.",
        m: fmtDate(ticket.createdAt)
      }
    ];

    const replies = getRepliesForTicket(ticket.rowId);
    replies.forEach(r => {
      timeline.push({
        t: r.reply_by ? `Reply by ${r.reply_by}` : "Reply added",
        d: r.reply_text || "â€”",
        m: fmtDate(r.created_at)
      });

      if (r.action_taken) {
        timeline.push({
          t:"Action taken",
          d:r.action_taken,
          m:fmtDate(r.created_at)
        });
      }
    });

    if (ticket.status === "Replied") {
      timeline.push({
        t:"Ticket marked as Replied",
        d:"Status updated to Replied.",
        m:"Status update"
      });
    }

    if (ticket.status === "Closed") {
      timeline.push({
        t:"Ticket closed",
        d:"Status updated to Closed.",
        m:"Status update"
      });
    }

    return timeline;
  }

  function computeKPIs(){
    const t = state.tickets || [];
    const open = t.filter(x => x.status === "Open" || x.status === "In Progress").length;
    const replied = t.filter(x =>
      x.status === "Replied" ||
      x.status === "Closed" ||
      getRepliesForTicket(x.rowId).length > 0
    ).length;

    $("kpiOpen").textContent = open;
    $("kpiReplied").textContent = replied;
    $("kpiSla").textContent = t.length ? "100%" : "0%";
    $("kpiAvg").textContent = t.length ? "2h" : "0h";
    $("kpiOpenT").textContent = `${open} active`;
    $("kpiRepliedT").textContent = `${replied} handled`;
    $("kpiSlaT").textContent = "Live";
    $("kpiAvgT").textContent = "Live";

    const bars = $("bars");
    bars.innerHTML = "";

    const branchCounts = {};
    t.forEach(ticket => {
      const branch = ticket.branch || "Other";
      branchCounts[branch] = (branchCounts[branch] || 0) + 1;
    });

    const values = Object.values(branchCounts).slice(0, 7);
    const displayValues = values.length ? values : [35, 50, 45, 70, 55, 80, 60];
    const max = Math.max(...displayValues, 1);

    displayValues.forEach(v=>{
      const el = document.createElement("div");
      el.className = "bar";
      el.style.height = `${Math.max(12, (v / max) * 100)}%`;
      bars.appendChild(el);
    });
  }

  async function loadRepliesMap(){
    try{
      const { data, error } = await supabaseClient
        .from("ticket_replies")
        .select("*")
        .order("created_at", { ascending:true });

      if(error){
        console.error("Replies load error:", error);
        return;
      }

      const grouped = {};
      (data || []).forEach(reply => {
        if (!reply.ticket_id) return;
        if (!grouped[reply.ticket_id]) grouped[reply.ticket_id] = [];
        grouped[reply.ticket_id].push(reply);
      });

      state.repliesByTicket = grouped;
    }catch(e){
      console.error("loadRepliesMap exception:", e);
    }
  }

  async function loadTickets(){
    try{
      const { data, error } = await supabaseClient
        .from("tickets")
        .select("*")
        .order("created_at", { ascending:false });

      if(error){
        console.error("Supabase load error:", error);
        $("systemMsg").textContent = "Load error: " + (error.message || "Unknown error");
        return;
      }

      state.tickets = (data || []).map(r => {
        const ticketLabel = (r.ticket_no !== null && r.ticket_no !== undefined)
          ? `#${r.ticket_no}`
          : (r.id ? `#${String(r.id).slice(0,8)}` : uid());

        const createdAt = r.created_at || new Date().toISOString();

        return {
          rowId: r.id || null,
          id: ticketLabel,
          ticketLabel,
          subject: `${ticketLabel} â€¢ ${r.branch_name || "â€”"}`,
          status: r.status || "Open",
          priority: r.priority || "Medium",
          branch: r.branch_name || "â€”",
          category: r.feedback_category || "â€”",
          source: r.feedback_type || "â€”",
          customerName: r.customer_name || "â€”",
          customerPhone: r.customer_phone || "â€”",
          createdAt,
          assignedTo: r.assign_to || "â€”",
          description: r.description || "â€”"
        };
      });

      if (!state.selectedId && state.tickets.length) {
        state.selectedId = state.tickets[0].rowId;
      }

      await loadRepliesMap();
      computeKPIs();

      if (currentView() === "tickets") renderTickets();
      renderDetail();

      $("systemMsg").textContent = `Connected. Loaded ${state.tickets.length} ticket(s).`;
    }catch(e){
      console.error("loadTickets exception:", e);
      $("systemMsg").textContent = "Exception: " + (e.message || e);
    }
  }

  function filterTickets(){
    const q = ($("globalSearch").value || "").toLowerCase().trim();
    const status = $("filterStatus").value;
    const prio = $("filterPriority").value;
    const branchQ = ($("filterBranch").value || "").toLowerCase().trim();

    return (state.tickets || []).filter(t => {
      const hay = `${t.id} ${t.subject} ${t.branch} ${t.customerName} ${t.customerPhone} ${t.category} ${t.source} ${t.description}`.toLowerCase();
      if (q && !hay.includes(q)) return false;
      if (status !== "all" && t.status !== status) return false;
      if (prio !== "all" && t.priority !== prio) return false;
      if (branchQ && !String(t.branch || "").toLowerCase().includes(branchQ)) return false;
      return true;
    });
  }

  function renderTickets(){
    const rows = $("ticketRows");
    const list = filterTickets();

    $("resultCount").textContent = `${list.length} tickets`;

    if (!state.selectedId && list[0]) state.selectedId = list[0].rowId;

    rows.innerHTML = "";
    list.forEach(t => {
      const r = document.createElement("div");
      r.className = "row" + (t.rowId === state.selectedId ? " active" : "");
      r.onclick = () => {
        state.selectedId = t.rowId;
        renderTickets();
        renderDetail();
      };

      const left = document.createElement("div");
      left.className = "meta";

      const title = document.createElement("div");
      title.className = "t";
      title.textContent = t.subject;

      const b = document.createElement("div");
      b.className = "b";
      b.innerHTML = `
        <span class="badge ${prioBadgeClass(t.priority)}">${t.priority}</span>
        <span class="badge ${statusBadgeClass(t.status)}">${t.status}</span>
        <span class="badge">${t.branch}</span>
      `;

      left.appendChild(title);
      left.appendChild(b);

      const right = document.createElement("div");
      right.className = "rightMeta";
      right.innerHTML = `<div>${t.id}</div><div>${fmtDate(t.createdAt)}</div>`;

      r.appendChild(left);
      r.appendChild(right);
      rows.appendChild(r);
    });

    renderDetail();
  }

  function renderDetail(){
    const t = (state.tickets || []).find(x => x.rowId === state.selectedId);
    if (!t) {
      $("detailTitle").textContent = "Select a ticket";
      $("detailSub").textContent = "Open a ticket to view details.";
      $("ticketInfo").innerHTML = "";
      $("ticketDesc").textContent = "â€”";
      $("branchReply").value = "";
      $("replyMeta").textContent = "â€”";
      $("timeline").innerHTML = "";
      return;
    }

    const latestReply = getLatestReply(t.rowId);

    $("detailTitle").textContent = t.subject;
    $("detailSub").textContent = `${t.id} â€¢ ${t.branch} â€¢ ${t.status}`;

    const info = [
      ["Ticket", t.id],
      ["Status", t.status],
      ["Priority", t.priority],
      ["Branch", t.branch],
      ["Category", t.category],
      ["Source", t.source],
      ["Customer", t.customerName],
      ["Phone", t.customerPhone],
      ["Assigned", t.assignedTo || "â€”"],
      ["Created", fmtDate(t.createdAt)]
    ];

    $("ticketInfo").innerHTML = info.map(([k,v]) => `<div><b>${k}:</b> ${v}</div>`).join("");
    $("ticketDesc").textContent = t.description || "â€”";
    $("branchReply").value = latestReply?.reply_text || "";

    $("replyMeta").textContent = latestReply
      ? `Reply by ${latestReply.reply_by || "â€”"} â€¢ ${fmtDate(latestReply.created_at)}${latestReply.action_taken ? " â€¢ " + latestReply.action_taken : ""}`
      : "No branch reply yet.";

    const tl = $("timeline");
    tl.innerHTML = "";
    buildTimeline(t).forEach(ev => {
      const wrap = document.createElement("div");
      wrap.className = "event";
      wrap.innerHTML = `
        <div class="dot"></div>
        <div class="box">
          <div class="t">${ev.t}</div>
          <div class="d">${ev.d}</div>
          <div class="m">${ev.m}</div>
        </div>
      `;
      tl.appendChild(wrap);
    });
  }

  async function createTicket(){
    try{
      const payload = {
        customer_name: "New Customer",
        customer_phone: "0500000000",
        branch_name: "Salamah",
        feedback_type: "Manual",
        feedback_category: "General",
        sub_category: "General",
        description: "New ticket created from CX Portal",
        priority: "Medium",
        status: "Open"
      };

      const { data, error } = await supabaseClient
        .from("tickets")
        .insert([payload])
        .select("*");

      if(error){
        console.error("Insert error:", error);
        alert("Ticket creation failed: " + (error.message || "Unknown error"));
        return;
      }

      if (data && data[0] && data[0].id) {
        state.selectedId = data[0].id;
      }

      await loadTickets();
      setView("tickets");
      renderTickets();
      alert("Ticket created successfully âœ…");
    }catch(e){
      console.error("createTicket exception:", e);
      alert("Exception: " + (e.message || e));
    }
  }

  async function saveReply(){
    const t = (state.tickets || []).find(x => x.rowId === state.selectedId);
    if (!t || !t.rowId) {
      alert("Please select a ticket first.");
      return;
    }

    const replyText = ($("branchReply").value || "").trim();
    if (!replyText) {
      alert("Please write a reply first.");
      return;
    }

    try{
      const { error } = await supabaseClient
        .from("ticket_replies")
        .insert([{
          ticket_id: t.rowId,
          reply_text: replyText,
          reply_by: "Branch",
          action_taken: "Reply saved"
        }]);

      if(error){
        console.error("Save reply error:", error);
        alert("Save reply failed: " + (error.message || "Unknown error"));
        return;
      }

      await loadRepliesMap();
      renderDetail();
      computeKPIs();
      alert("Reply saved âœ…");
    }catch(e){
      console.error("saveReply exception:", e);
      alert("Exception: " + (e.message || e));
    }
  }

  async function markReplied(){
    const t = (state.tickets || []).find(x => x.rowId === state.selectedId);
    if (!t || !t.rowId) return;

    try{
      const { error } = await supabaseClient
        .from("tickets")
        .update({ status:"Replied" })
        .eq("id", t.rowId);

      if(error){
        console.error("Mark replied error:", error);
        alert("Mark replied failed: " + (error.message || "Unknown error"));
        return;
      }

      await loadTickets();
      renderTickets();
      renderDetail();
      alert("Ticket marked as Replied âœ…");
    }catch(e){
      console.error("markReplied exception:", e);
      alert("Exception: " + (e.message || e));
    }
  }

  async function closeTicket(){
    const t = (state.tickets || []).find(x => x.rowId === state.selectedId);
    if (!t || !t.rowId) return;

    try{
      const { error } = await supabaseClient
        .from("tickets")
        .update({ status:"Closed" })
        .eq("id", t.rowId);

      if(error){
        console.error("Close ticket error:", error);
        alert("Close failed: " + (error.message || "Unknown error"));
        return;
      }

      await loadTickets();
      renderTickets();
      renderDetail();
      alert("Ticket closed âœ…");
    }catch(e){
      console.error("closeTicket exception:", e);
      alert("Exception: " + (e.message || e));
    }
  }

  function assignTicket(){
    alert("Assign button ready. Next step we can connect it later to Supabase assign_to.");
  }

  function addNote(){
    alert("Add Note button ready. Next step we can connect it later to a notes table.");
  }

  function exportJSON(){
    const data = {
      exportedAt: new Date().toISOString(),
      tickets: state.tickets,
      repliesByTicket: state.repliesByTicket
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "cx_portal_export.json";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  document.addEventListener("keydown", (e)=>{
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k"){
      e.preventDefault();
      $("globalSearch").focus();
    }
  });

  document.querySelectorAll(".nav button").forEach(btn=>{
    btn.addEventListener("click", ()=> setView(btn.dataset.view));
  });

  $("goTickets").onclick = ()=> setView("tickets");
  $("goReports").onclick = ()=> setView("reports");
  $("goSettings").onclick = ()=> setView("settings");

  ["filterStatus","filterPriority","filterBranch"].forEach(id=>{
    $(id).addEventListener("input", renderTickets);
    $(id).addEventListener("change", renderTickets);
  });

  $("globalSearch").addEventListener("input", renderTickets);

  $("btnTheme").onclick = ()=>{
    state.theme = state.theme === "dark" ? "light" : "dark";
    applyTheme();
  };

  $("btnLang").onclick = ()=>{
    state.lang = state.lang === "en" ? "ar" : "en";
    applyLang();
    renderTickets();
    setView(currentView());
  };

  $("btnNewTicket").onclick = createTicket;
  $("btnExport").onclick = exportJSON;
  $("btnSaveReply").onclick = saveReply;
  $("btnMarkReplied").onclick = markReplied;
  $("btnClose").onclick = closeTicket;
  $("btnAssign").onclick = assignTicket;
  $("btnAddNote").onclick = addNote;

  $("saveBrand").onclick = ()=>{
    const v = $("brandInput").value.trim();
    if(v){
      state.brandTitle = v;
      $("brandTitle").textContent = v;
      alert("Brand saved âœ…");
    }
  };

  (async function init(){
    applyTheme();
    applyLang();
    computeKPIs();
    setView("dashboard");
    await loadTickets();
  })();
</script>
